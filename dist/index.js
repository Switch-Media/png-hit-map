!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).PngHitMap={})}(this,(function(t){"use strict";const e="undefined"!=typeof window&&"undefined"!=typeof document,o="undefined"!=typeof process&&!!process.versions&&!!process.versions.node;async function i(t,i={}){const n=i.gridPercent||1,r=!1!==i.base64Output;let a,l,f;if(e){let o=t;"string"==typeof t&&(o=await function(t){if(!e)throw new Error("Image loading requires a browser environment");return new Promise(((e,o)=>{const i=new Image;i.onload=()=>e(i),i.onerror=()=>o(new Error(`Failed to load image at ${t}`)),i.src=t}))}(t));const i=document.createElement("canvas"),n=i.getContext("2d");if(!n)throw new Error("Failed to get canvas context");i.width=o.width,i.height=o.height,n.drawImage(o,0,0);const r=n.getImageData(0,0,i.width,i.height);f=new Uint8Array(r.data.buffer),a=i.width,l=i.height}else{if(!o)throw new Error("Unsupported environment for createHitMap");{const{PNG:e}=await import("pngjs"),o=await import("fs");let i;if("string"==typeof t)i=await o.promises.readFile(t);else{if(!(t instanceof Uint8Array||Buffer.isBuffer(t)))throw new Error("Image must be a file path or Buffer in Node.js");i=Buffer.from(t)}const n=e.sync.read(i);a=n.width,l=n.height,f=n.data}}const h=Math.max(1,Math.floor(n/100*a)),s=Math.max(1,Math.floor(n/100*l)),g=Math.ceil(a/h),c=Math.ceil(l/s),d=new Uint8Array(g*c);for(let t=0;t<l;t++)for(let e=0;e<a;e++){if(f[4*(t*a+e)+3]>0){const o=Math.floor(e/h);d[Math.floor(t/s)*g+o]=1}}e&&window._pngHitMapVisualization&&(window._pngHitMapMetadata={width:a,height:l,gridSizeX:h,gridSizeY:s,gridWidth:g,gridHeight:c});const w=function(t,e){const o=[];let i=t[0],n=1;for(let e=1;e<t.length;e++)t[e]===i?n++:(o.push(n),i=t[e],n=1);o.push(n);let r=2;for(const t of o)r+=t<255?1:5;const a=new ArrayBuffer(r),l=new DataView(a);l.setUint8(0,Math.round(e)),l.setUint8(1,t[0]);let f=2;for(const t of o)t<255?(l.setUint8(f,t),f+=1):(l.setUint8(f,255),f+=1,l.setUint32(f,t,!0),f+=4);return a}(d,n);return r?function(t){if(e){const e=new Uint8Array(t);let o="";for(let t=0;t<e.byteLength;t++)o+=String.fromCharCode(e[t]);return btoa(o)}return Buffer.from(t).toString("base64")}(w):w}function n(t,o,i,n){if(!n||!n.width||!n.height)throw new Error("Image dimensions are required for hit detection. Please provide imageInfo parameter with width and height.");let r;r="string"==typeof t?function(t){if(e){const e=atob(t),o=new Uint8Array(e.length);for(let t=0;t<e.length;t++)o[t]=e.charCodeAt(t);return o.buffer}return Buffer.from(t,"base64").buffer}(t):t;const a=new DataView(r).getUint8(0),l=n.width,f=n.height,h=Math.max(1,Math.floor(a/100*l)),s=Math.max(1,Math.floor(a/100*f)),g=Math.ceil(l/h),c=Math.floor(o/100*l),d=Math.floor(i/100*f),w=Math.floor(c/h);return function(t,e){const o=new DataView(t),i=o.getUint8(1);let n=i,r=0,a=2;for(;r<=e;){let t=o.getUint8(a);if(a+=1,255===t&&(t=o.getUint32(a,!0),a+=4),r+t>e)return 1===n;r+=t,n=0===n?1:0}return!1}(r,Math.floor(d/s)*g+w)}const r="undefined"!=typeof window&&"undefined"!=typeof document;function a(t){if(r){const e=atob(t),o=new Uint8Array(e.length);for(let t=0;t<e.length;t++)o[t]=e.charCodeAt(t);return o.buffer}return Buffer.from(t,"base64").buffer}var l=Object.freeze({__proto__:null,analyzeRLEData:function(t){let e;e="string"==typeof t?a(t):t;const o=new DataView(e),i=o.getUint8(0),n=o.getUint8(1);let r=0,l=0,f=0,h=n,s=2;for(;s<e.byteLength;){let t;255===o.getUint8(s)?(s+=1,t=o.getUint32(s,!0),s+=4):(t=o.getUint8(s),s+=1),r++,l+=t,1===h&&(f+=t),h=1-h}return{gridPercent:i,startValue:n,totalRuns:r,totalCells:l,hitCells:f,compressionRatio:e.byteLength/l}},createVisualizationData:function(t,e,o){const i=[];for(let n=0;n<o;n++){let o=[],r=0,a=t[n*e];for(let i=1;i<=e;i++)if(i===e||t[n*e+i]!==a){const l={value:a,count:i-r,row:n,startX:r,endX:i-1};o.push(l),i<e&&(a=t[n*e+i],r=i)}i.push(o)}return i},formatRLEHex:function(t){let e;e="string"==typeof t?a(t):t;const o=new Uint8Array(e);let i="";for(let t=0;t<o.length;t++){i+=o[t].toString(16).padStart(2,"0")+" ",(t+1)%16==0&&(i+="\n")}return i},getVisualizationData:()=>r&&window._pngHitMapMetadata||null,storeVisualizationData:(t,e,o)=>{r&&(window._pngHitMapMetadata={width:e,height:o,grid:t})},visualizeGrid:function(t,e,o,i={}){if(!r)throw new Error("Visualization requires a browser environment with Canvas support");const n=t.getContext("2d");if(!n)throw new Error("Failed to get canvas context");let l;l="string"==typeof e?a(e):e;const f=new DataView(l),h=f.getUint8(0),s=o.width,g=o.height,c=Math.max(1,Math.floor(h/100*s)),d=Math.max(1,Math.floor(h/100*g)),w=Math.ceil(s/c);t.width===s&&t.height===g||(t.width=s,t.height=g),n.clearRect(0,0,t.width,t.height);let u=0,p=f.getUint8(1),M=2;for(n.fillStyle=i.fillColor||"rgba(0, 255, 0, 0.2)";M<l.byteLength;){let t;if(255===f.getUint8(M)?(M+=1,t=f.getUint32(M,!0),M+=4):(t=f.getUint8(M),M+=1),1===p)for(let e=0;e<t;e++){const t=u+e,o=Math.floor(t/w),i=t%w;n.fillRect(i*c,o*d,c,d)}u+=t,p=1-p}if(i.showGrid){n.strokeStyle=i.gridColor||"rgba(255, 0, 0, 0.5)",n.lineWidth=i.lineWidth||1;for(let t=0;t<=s;t+=c)n.beginPath(),n.moveTo(t,0),n.lineTo(t,g),n.stroke();for(let t=0;t<=g;t+=d)n.beginPath(),n.moveTo(0,t),n.lineTo(s,t),n.stroke()}},visualizeGridDirect:function(t,e,o,i={}){if(!r)throw new Error("Visualization requires a browser environment with Canvas support");const l=t.getContext("2d");if(!l)throw new Error("Failed to get canvas context");let f;l.clearRect(0,0,t.width,t.height),f="string"==typeof e?a(e):e;const h=new DataView(f).getUint8(0),s=Math.max(1,Math.floor(h/100*o.width)),g=Math.max(1,Math.floor(h/100*o.height)),c=Math.ceil(o.width/s),d=Math.ceil(o.height/g),w=t.width/o.width,u=t.height/o.height;if(i.showGrid){l.strokeStyle=i.gridColor||"rgba(0, 0, 0, 0.3)",l.lineWidth=1;for(let e=0;e<=c;e++){const o=Math.floor(e*s*w);l.beginPath(),l.moveTo(o,0),l.lineTo(o,t.height),l.stroke()}for(let e=0;e<=d;e++){const o=Math.floor(e*g*u);l.beginPath(),l.moveTo(0,o),l.lineTo(t.width,o),l.stroke()}}if(i.fillColor){l.fillStyle=i.fillColor||"rgba(0, 255, 0, 0.4)";for(let t=0;t<d;t++)for(let i=0;i<c;i++){const r=Math.floor(i*s*w),a=Math.floor(t*g*u),f=Math.ceil(s*w),h=Math.ceil(g*u);n(e,i*s/o.width*100,t*g/o.height*100,o)&&l.fillRect(r,a,f,h)}}},visualizeRLERuns:function(t,e,o={}){if(!r)throw new Error("Visualization requires a browser environment with Canvas support");const i=t.getContext("2d");if(!i)throw new Error("Failed to get canvas context");let n;n="string"==typeof e?a(e):e;const l=new DataView(n);l.getUint8(0);const f=l.getUint8(1);i.clearRect(0,0,t.width,t.height);let h=f,s=2,g=0;for(;s<n.byteLength;){let t;255===l.getUint8(s)?(s+=1,t=l.getUint32(s,!0),s+=4):(t=l.getUint8(s),s+=1),i.fillStyle=1===h?o.fillColor||"rgba(0, 255, 0, 0.4)":"rgba(255, 0, 0, 0.1)",i.fillRect(0,g,2*t,20),i.fillStyle="black",i.font="12px monospace",i.fillText(t.toString(),2*t+5,g+15),g+=25,h=1-h}}}),f={createHitMap:i,testHit:n};t.createHitMap=i,t.default=f,t.testHit=n,t.visualTools=l,Object.defineProperty(t,"__esModule",{value:!0})}));
//# sourceMappingURL=index.js.map

!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).PngHitMap={})}(this,(function(t){"use strict";const e="undefined"!=typeof window&&"undefined"!=typeof document;async function i(t,i={}){if(!e)throw new Error("createHitMap requires a browser environment with Canvas support");const o=i.gridPercent||1,n=!1!==i.base64Output;let r=t;"string"==typeof t&&(r=await function(t){if(!e)throw new Error("Image loading requires a browser environment");return new Promise(((e,i)=>{const o=new Image;o.onload=()=>e(o),o.onerror=()=>i(new Error(`Failed to load image at ${t}`)),o.src=t}))}(t));const a=document.createElement("canvas"),l=a.getContext("2d");if(!l)throw new Error("Failed to get canvas context");a.width=r.width,a.height=r.height,l.drawImage(r,0,0);const h=l.getImageData(0,0,a.width,a.height).data,f=Math.max(1,Math.floor(o/100*a.width)),s=Math.max(1,Math.floor(o/100*a.height)),g=Math.ceil(a.width/f),c=Math.ceil(a.height/s),d=new Uint8Array(g*c);for(let t=0;t<a.height;t++)for(let e=0;e<a.width;e++){if(h[4*(t*a.width+e)+3]>0){const i=Math.floor(e/f);d[Math.floor(t/s)*g+i]=1}}e&&window._pngHitMapVisualization&&(window._pngHitMapMetadata={width:a.width,height:a.height,gridSizeX:f,gridSizeY:s,gridWidth:g,gridHeight:c});const w=function(t,e){const i=[];let o=t[0],n=1;for(let e=1;e<t.length;e++)t[e]===o?n++:(i.push(n),o=t[e],n=1);i.push(n);let r=2;for(const t of i)r+=t<255?1:5;const a=new ArrayBuffer(r),l=new DataView(a);l.setUint8(0,Math.round(e)),l.setUint8(1,t[0]);let h=2;for(const t of i)t<255?(l.setUint8(h,t),h+=1):(l.setUint8(h,255),h+=1,l.setUint32(h,t,!0),h+=4);return a}(d,o);return n?function(t){if(e){const e=new Uint8Array(t);let i="";for(let t=0;t<e.byteLength;t++)i+=String.fromCharCode(e[t]);return btoa(i)}return Buffer.from(t).toString("base64")}(w):w}function o(t,i,o,n){if(!n||!n.width||!n.height)throw new Error("Image dimensions are required for hit detection. Please provide imageInfo parameter with width and height.");let r;r="string"==typeof t?function(t){if(e){const e=atob(t),i=new Uint8Array(e.length);for(let t=0;t<e.length;t++)i[t]=e.charCodeAt(t);return i.buffer}return Buffer.from(t,"base64").buffer}(t):t;const a=new DataView(r).getUint8(0),l=n.width,h=n.height,f=Math.max(1,Math.floor(a/100*l)),s=Math.max(1,Math.floor(a/100*h)),g=Math.ceil(l/f),c=Math.floor(i/100*l),d=Math.floor(o/100*h),w=Math.floor(c/f);return function(t,e){const i=new DataView(t),o=i.getUint8(1);let n=o,r=0,a=2;for(;r<=e;){let t=i.getUint8(a);if(a+=1,255===t&&(t=i.getUint32(a,!0),a+=4),r+t>e)return 1===n;r+=t,n=0===n?1:0}return!1}(r,Math.floor(d/s)*g+w)}const n="undefined"!=typeof window&&"undefined"!=typeof document;function r(t){if(n){const e=atob(t),i=new Uint8Array(e.length);for(let t=0;t<e.length;t++)i[t]=e.charCodeAt(t);return i.buffer}return Buffer.from(t,"base64").buffer}var a=Object.freeze({__proto__:null,analyzeRLEData:function(t){let e;e="string"==typeof t?r(t):t;const i=new DataView(e),o=i.getUint8(0),n=i.getUint8(1);let a=0,l=0,h=0,f=n,s=2;for(;s<e.byteLength;){let t;255===i.getUint8(s)?(s+=1,t=i.getUint32(s,!0),s+=4):(t=i.getUint8(s),s+=1),a++,l+=t,1===f&&(h+=t),f=1-f}return{gridPercent:o,startValue:n,totalRuns:a,totalCells:l,hitCells:h,compressionRatio:e.byteLength/l}},createVisualizationData:function(t,e,i){const o=[];for(let n=0;n<i;n++){let i=[],r=0,a=t[n*e];for(let o=1;o<=e;o++)if(o===e||t[n*e+o]!==a){const l={value:a,count:o-r,row:n,startX:r,endX:o-1};i.push(l),o<e&&(a=t[n*e+o],r=o)}o.push(i)}return o},formatRLEHex:function(t){let e;e="string"==typeof t?r(t):t;const i=new Uint8Array(e);let o="";for(let t=0;t<i.length;t++){o+=i[t].toString(16).padStart(2,"0")+" ",(t+1)%16==0&&(o+="\n")}return o},getVisualizationData:()=>n&&window._pngHitMapMetadata||null,storeVisualizationData:(t,e,i)=>{n&&(window._pngHitMapMetadata={width:e,height:i,grid:t})},visualizeGrid:function(t,e,i,o={}){if(!n)throw new Error("Visualization requires a browser environment with Canvas support");const a=t.getContext("2d");if(!a)throw new Error("Failed to get canvas context");let l;l="string"==typeof e?r(e):e;const h=new DataView(l),f=h.getUint8(0),s=i.width,g=i.height,c=Math.max(1,Math.floor(f/100*s)),d=Math.max(1,Math.floor(f/100*g)),w=Math.ceil(s/c);t.width===s&&t.height===g||(t.width=s,t.height=g),a.clearRect(0,0,t.width,t.height);let u=0,p=h.getUint8(1),M=2;for(a.fillStyle=o.fillColor||"rgba(0, 255, 0, 0.2)";M<l.byteLength;){let t;if(255===h.getUint8(M)?(M+=1,t=h.getUint32(M,!0),M+=4):(t=h.getUint8(M),M+=1),1===p)for(let e=0;e<t;e++){const t=u+e,i=Math.floor(t/w),o=t%w;a.fillRect(o*c,i*d,c,d)}u+=t,p=1-p}if(o.showGrid){a.strokeStyle=o.gridColor||"rgba(255, 0, 0, 0.5)",a.lineWidth=o.lineWidth||1;for(let t=0;t<=s;t+=c)a.beginPath(),a.moveTo(t,0),a.lineTo(t,g),a.stroke();for(let t=0;t<=g;t+=d)a.beginPath(),a.moveTo(0,t),a.lineTo(s,t),a.stroke()}},visualizeGridDirect:function(t,e,i,a={}){if(!n)throw new Error("Visualization requires a browser environment with Canvas support");const l=t.getContext("2d");if(!l)throw new Error("Failed to get canvas context");let h;l.clearRect(0,0,t.width,t.height),h="string"==typeof e?r(e):e;const f=new DataView(h).getUint8(0),s=Math.max(1,Math.floor(f/100*i.width)),g=Math.max(1,Math.floor(f/100*i.height)),c=Math.ceil(i.width/s),d=Math.ceil(i.height/g),w=t.width/i.width,u=t.height/i.height;if(a.showGrid){l.strokeStyle=a.gridColor||"rgba(0, 0, 0, 0.3)",l.lineWidth=1;for(let e=0;e<=c;e++){const i=Math.floor(e*s*w);l.beginPath(),l.moveTo(i,0),l.lineTo(i,t.height),l.stroke()}for(let e=0;e<=d;e++){const i=Math.floor(e*g*u);l.beginPath(),l.moveTo(0,i),l.lineTo(t.width,i),l.stroke()}}if(a.fillColor){l.fillStyle=a.fillColor||"rgba(0, 255, 0, 0.4)";for(let t=0;t<d;t++)for(let n=0;n<c;n++){const r=Math.floor(n*s*w),a=Math.floor(t*g*u),h=Math.ceil(s*w),f=Math.ceil(g*u);o(e,n*s/i.width*100,t*g/i.height*100,i)&&l.fillRect(r,a,h,f)}}},visualizeRLERuns:function(t,e,i={}){if(!n)throw new Error("Visualization requires a browser environment with Canvas support");const o=t.getContext("2d");if(!o)throw new Error("Failed to get canvas context");let a;a="string"==typeof e?r(e):e;const l=new DataView(a);l.getUint8(0);const h=l.getUint8(1);o.clearRect(0,0,t.width,t.height);let f=h,s=2,g=0;for(;s<a.byteLength;){let t;255===l.getUint8(s)?(s+=1,t=l.getUint32(s,!0),s+=4):(t=l.getUint8(s),s+=1),o.fillStyle=1===f?i.fillColor||"rgba(0, 255, 0, 0.4)":"rgba(255, 0, 0, 0.1)",o.fillRect(0,g,2*t,20),o.fillStyle="black",o.font="12px monospace",o.fillText(t.toString(),2*t+5,g+15),g+=25,f=1-f}}}),l={createHitMap:i,testHit:o};t.createHitMap=i,t.default=l,t.testHit=o,t.visualTools=a,Object.defineProperty(t,"__esModule",{value:!0})}));
//# sourceMappingURL=index.js.map
